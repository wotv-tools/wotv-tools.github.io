<!DOCTYPE html>
<html>
<head>
<script src="jquery-3.5.0.min.js" type="text/javascript"></script>
<link href="base.css" rel="stylesheet" type="text/css">
<link id="theme" href="dark.css" rel="stylesheet" type="text/css">
<script>
  if (window.localStorage.getItem('light')) {
    $('head #theme').attr('href', 'light.css');
  }
  function toggleCSS() {
    if (window.localStorage.getItem('light')) {
      window.localStorage.removeItem('light');
      $('head #theme').attr('href', 'dark.css');
    } else {
      window.localStorage.setItem('light', true);
      $('head #theme').attr('href', 'light.css');
    }
  }
</script>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-164908860-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-164908860-1');
</script>
<title>WotV:FFBE Equipment Calculator</title>
</head>
<body>
  <div id="header">
    Equipment Calculator
    <div id="css_toggle" onclick="toggleCSS()">
      <img id="light" src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_UN_AW_SHINE.png" title="Turn off Dark Mode"/>
      <img id="dark" src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_UN_AW_DARK.png" title="Turn on Dark Mode"/>
    </div>
  </div>

  <div id="main_content">
    <div id="inputs">
      <select id="category" onchange="onCategoryChange()">
        <option disabled selected>-- Select an category --</option>
        <optgroup id="category-weapon" label="Weapon"></optgroup>
        <optgroup id="category-armor" label="Armor"></optgroup>
        <optgroup id="category-accessory" label="Accessory"></optgroup>
      </select>
      <select id="artifacts" class="hidden" onchange="onArtifactChange()"></select>
      <select id="level" class="hidden" onchange="onLevelChange()"></select>
      <button id="itemLink" onclick="copyItemLink()" class="hidden">Copy Item Link</button>
      <textarea id="copyText" style="opacity:0;height:0;width:0;"></textarea>
    </div>
    <div id="start_tip" class="tips">
      <div class="speech_bubble">Welcome! This tool calculates the average stat gain for equipment. To get started, choose an equipment from the inputs above! If you wish to learn from my brother, click on the Awakening Prism at the top at anytime.</div>
    </div>

    <div id="content" class="hidden">
      <div class="grid">
        <div class="cell" id="info">
          <div class="cell_content">
            <div id="item_image" class="equipment">
              <img src=""/>
            </div>
            <table>
              <tr>
                <td><b>Rarity</b></td>
                <td id="rarity"></td>
              </tr>
              <tr>
                <td><b>Type</b></td>
                <td id="type"></td>
              </tr>
              <!-- <tr>
                <td id="skills" colspan="2"></td>
              </tr> -->
            </table>
          </div>
        </div>

        <div class="cell" id="growth">
          <div class="cell_content">
            <table id="stats">
              <tr>
                <th colspan="14">Average Stat Growth</th>
              </tr>
              <tr>
                <th>Growth<br/>Type</th>
                <th>HP</th>
                <th>TP</th>
                <th>AP</th>
                <th>ATK</th>
                <th>DEF</th>
                <th>MAG</th>
                <th>SPR</th>
                <th>ACC</th>
                <th>DEX</th>
                <th>AGI</th>
                <th>EVADE</th>
                <th>CRIT</th>
                <th>CRIT<br/>EVADE</th>
              </tr>
              <tr id="grow1_stats" class="selectable" onclick="save(this)"></tr>
              <tr id="grow2_stats" class="selectable" onclick="save(this)"></tr>
              <tr id="grow3_stats" class="selectable" onclick="save(this)"></tr>
              <tr id="grow_div" class="hidden"></tr>
              <tr id="grow_amt" class="hidden"></tr>
              <tr id="seals" class="hidden">
                <th>Seals</th>
                <td class="stat stat_0" onclick="toggleSeal(0)">
                  <label for=""><img src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_AF_SUP_HP.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td></td>
                <td></td>
                <td class="stat stat_3" onclick="toggleSeal(3)">
                  <label for=""><img src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_AF_SUP_ATK.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_4" onclick="toggleSeal(4)">
                  <label for=""><img src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_AF_SUP_DEF.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_5" onclick="toggleSeal(5)">
                  <label for=""><img src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_AF_SUP_MAG.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_6" onclick="toggleSeal(6)">
                  <label for=""><img src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_AF_SUP_MND.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_7" onclick="toggleSeal(7)">
                  <label for=""><img src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_AF_SUP_HIT.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td></td>
                <td></td>
                <td class="stat stat_10" onclick="toggleSeal(10)">
                  <label for=""><img src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_AF_SUP_AVO.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td class="stat stat_11" onclick="toggleSeal(11)">
                  <label for=""><img src="https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/IT_AF_SUP_CRI.png"/></label>
                  <input type="checkbox" class="hidden" disabled />
                </td>
                <td></td>
              </tr>
              <tr id="equipment_pass" class="hidden">
                <td>
                  Equipment Training Pass<br/>
                  <input id="eq_pass_val" type="checkbox" onchange="displayStats()" />
                </td>
                <td class="stat stat_0"><span class="hidden">+15%</span></td>
                <td></td>
                <td></td>
                <td class="stat stat_3"><span class="hidden">+15%</span></td>
                <td class="stat stat_4"><span class="hidden">+3%</span></td>
                <td class="stat stat_5"><span class="hidden">+15%</span></td>
                <td class="stat stat_6"><span class="hidden">+3%</span></td>
                <td class="stat stat_7"><span class="hidden">+3%</span></td>
                <td></td>
                <td></td>
                <td class="stat stat_10"><span class="hidden">+3%</span></td>
                <td class="stat stat_11"><span class="hidden">+3%</span></td>
                <td></td>
              </tr>
            </table>
          </div>
          <div id="seals_tip" class="tips hidden">
            <div class="speech_bubble">Click on the seals above to see how the average changes with seals! Seals are applied every level until the stat is maxed.</div>
          </div>
          <div id="save_tip" class="tips hidden">
            <div class="speech_bubble">If you like what you see, you can click on the entry to save it down below!</div>
          </div>
        </div>
      </div>

      <div id="materials" class="grid hidden">
        <div id="recipe_mats" class="cell">
          <div class="cell_content">
            <table></table>
          </div>
        </div>
        <div id="awake_mats" class="cell">
          <div class="cell_content">
            <table></table>
          </div>
        </div>
        <div id="total_mats" class="cell">
          <div class="cell_content">
            <table></table>
          </div>
        </div>
      </div>
    </div>

    <div id="saved" class="grid hidden">
      <div class="cell">
        <div class="cell_content">
          <textarea class="hidden" id="copy_txt"></textarea>
          <table>
            <tr>
              <th colspan="15">Saved Equipment</th>
            <tr>
              <th>Equipment</th>
              <th></th>
              <th>HP</th>
              <th>TP</th>
              <th>AP</th>
              <th>ATK</th>
              <th>DEF</th>
              <th>MAG</th>
              <th>SPR</th>
              <th>ACC</th>
              <th>DEX</th>
              <th>AGI</th>
              <th>EVADE</th>
              <th>CRIT</th>
              <th>CRIT<br/>EVADE</th>
            </tr>
          </table>
        </div>
        <div class="tips hidden">
          <div class="speech_bubble">You can remove any unwanted entries by clicking on them! Once you are ready, you can share the link above.</div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <a href="https://www.reddit.com/r/wotv_ffbe/comments/gd685f/lets_congregate_some_resources/">Other WotV Resources</a> |
    <a target="_blank" href="changelogs.html">Change Logs (Last updated 2021-03-11)</a> |
    <a href="levelup.html">Level Up Assistant</a> |
    Report Issues (<a target="_blank" href="https://github.com/wotv-tools/wotv-tools.github.io/issues/new">Github</a>|<a target="_blank" href="https://www.reddit.com/message/compose/?to=sairenkao&subject=Equipment%20Calculator">Reddit</a>) |
    <a target="_blank" href="https://github.com/shalzuth/wotv-ffbe-dump">Data source</a> |
    <a target="_blank" href="legal.html">Legal</a>
  </footer>

  <script>
    let mat_link = 'https://wotvfarmcalculator.github.io/?i=';
    let stats = [{
      label: "HP",
      value: "hp"
    }, {
      label: "TP",
      value: "mp"
    }, {
      label: "AP",
      value: "ap"
    }, {
      label: "ATK",
      value: "atk"
    }, {
      label: "DEF",
      value: "def"
    }, {
      label: "MAG",
      value: "mag"
    }, {
      label: "SPR",
      value: "mnd"
    }, {
      label: "ACC",
      value: "hit"
    }, {
      label: "DEX",
      value: "dex"
    }, {
      label: "AGI",
      value: "spd"
    }, {
      label: "EVA",
      value: "avd"
    }, {
      label: "CRIT",
      value: "crt"
    }, {
      label: "CRIT EVADE",
      value: "crta"
    }];

    function onCategoryChange() {
      let category = $('#category').val();

      $('#artifacts').empty();
      artifactListByCat[category].forEach((artifact) => {
        $('#artifacts').append('<option value="' + artifact.value + '">' + artifact.label + '</option>');
      });

      $('#artifacts').removeClass('hidden');
      $('#artifacts').change();
    }
    function onArtifactChange() {
      $('#start_tip').addClass('dismissed');
      resetSealsAndPass();
      setItemInfo();
    }
    function onLevelChange() {
      displayStats();
    }

    function copyItemLink() {
      let hash = {
        category: $('#category').val(),
        artifact: $('#artifacts').val(),
        level: $('#level').val()
      };

      $('#copyText').text(window.location.href.replace(window.location.hash, "") + '#' + btoa(JSON.stringify(hash)));
      $('#copyText').select();
      document.execCommand('copy');
      alert('Copied Item Link to clipboard!');
    }

    function displayStats() {
      let itemKey = $('#artifacts').val();
      if (!itemKey) {
        return;
      }

      let item = artifactMap[itemKey];
      let level = parseInt($('#level').val());
      let item_sk = item['skl' + Math.ceil(level/10)];

      $('#item_image img').attr('src', 'https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/equipment/' + item.asset + '.png');

      $('#type').empty();
      item.cat.forEach((cat) => {
        $('#type').append('<div>' + artifactCategoryList[cat].value + '</div>');
      });

      $('#rarity').empty();
      switch (item.rare) {
        case 0:
          $('#rarity').append('<div>N</div>');
          break;
        case 1:
          $('#rarity').append('<div>R</div>');
          break;
        case 2:
          $('#rarity').append('<div>SR</div>');
          break;
        case 3:
          $('#rarity').append('<div>MR</div>');
          break;
        case 4:
          $('#rarity').append('<div>UR</div>');
          break;
      }

      // $('#skills').empty();
      // if (item_sk) {
      //   item_sk.forEach((skl) => {
      //     let skill = skillMap[skl];
      //     if (skill.grow == 'SKILL_DEFAULT' && skillNameMap[skl]) {
      //         $('#skills').append('<div class="skill_desc">' + skillNameMap[skl] + '</div>');
      //     } else {
      //       if (skill.s_buffs) {
      //         skill.s_buffs.forEach((s_buff) => {
      //           $('#skills').append(getBuffNames(s_buff, skill.grow, level));
      //         });
      //       }
      //       if (skill.t_buffs) {
      //         skill.t_buffs.forEach((t_buff) => {
      //           $('#skills').append(getBuffNames(t_buff, skill.grow, level));
      //         });
      //       }
      //     }
      //   });
      // }
      //
      // if (!$.trim($('#skills').html())) {
      //     $('#skills').append('<div>-</div>');
      // }

      // $('#desc').empty();
      // $('#desc').append(artifactFlavorMap[item.iname]);

      $('#grow1_stats').empty();
      $('#grow2_stats').empty();
      $('#grow3_stats').empty();
      let types = typeMap[item.rtype];

      types.forEach((type, i) => {
        let typeGrowth = growthMap[type.value];
        let typeStatsRow = $('#grow' + (i+1) + '_stats');
        let artifact_stats, artifact_rates, ave_stats;

        switch (type.value) {
          case 'ARTIFACT_TRUST':
            artifact_stats = item.status[1];
            ave_stats = item.status[1];
            break;
          case 'ARTIFACT_50':
            artifact_stats = item.status[1];
            ave_stats = Object.assign({}, item.status[0]);

            stats.forEach((stat) => {
              if (!isNaN(artifact_stats[stat.value])) {
                // guessing growth for no rstatus growth
                ave_stats[stat.value] = item.status[0][stat.value]
                    + (item.status[1][stat.value]
                    - item.status[0][stat.value])
                      * Math.min(level-1, typeGrowth.curve[0].lv-1)
                      / (typeGrowth.curve[0].lv-1);
              }
            });

            break;
          default:
            artifact_stats = getArtifactStats(typeGrowth.curve[0], item.status[1]);
            artifact_rates = getArtifactRates(typeGrowth.rstatus[0], item.randr[0]);
            ave_stats = Object.assign({}, item.status[0]);

            for (let i = 1; i < level; i++) {
              let pity_rate = 1;
              let pity_stat;

              stats.forEach((stat) => {
                if (!isNaN(artifact_rates[stat.value])) {
                  // pity rate still affected even if growth amount is 0
                  pity_rate *= (1 - (artifact_rates[stat.value] / 100));

                  if (!pity_stat || artifact_rates[stat.value] > artifact_rates[pity_stat]) {
                      pity_stat = stat.value;
                  }
                }

                if (!isNaN(artifact_stats[stat.value])
                    && !isNaN(item.randa[0][stat.value])
                    && !isNaN(artifact_rates[stat.value])) {
                  ave_stats[stat.value] += item.randa[0][stat.value]
                          * artifact_rates[stat.value] / 100;
                  // can still be pity stat as long as stat exists
                  // even without actual rate/amount increases
                  if (ave_stats[stat.value] > artifact_stats[stat.value]) {
                    ave_stats[stat.value] = artifact_stats[stat.value];
                    artifact_rates[stat.value] = 0;
                  }
                }
              });

              // add pity
              ave_stats[pity_stat] += pity_rate;
              if (ave_stats[pity_stat] > artifact_stats[pity_stat]) {
                ave_stats[pity_stat] = artifact_stats[pity_stat];
                artifact_rates[pity_stat] = 0;
              }
            }

            // reset. get base artifact rates
            artifact_rates = getArtifactRates(typeGrowth.rstatus[0], item.randr[0]);

            break;
        }

        typeStatsRow.append('<td><b>' + (type.label ? type.label : '-') + '</b></td>');
        stats.forEach((stat, i) => {
          if (ave_stats[stat.value] > artifact_stats[stat.value]) {
            ave_stats[stat.value] = artifact_stats[stat.value];
            artifact_rates[stat.value] = 0;
          } else {
            ave_stats[stat.value] = Math.round(ave_stats[stat.value]);
          }

          if (!isNaN(item.status[0][stat.value]) && !isNaN(item.status[1][stat.value])
              && (item.status[0][stat.value] != 0 || item.status[1][stat.value] != 0)) {
            let tdEl = '';
            if (seals[i]) {
              tdEl = '<td><b>' + ave_stats[stat.value] + '</b> / ' + artifact_stats[stat.value];
              if (artifact_rates) {
                tdEl += '<br/><span><b>' + artifact_rates[stat.value] + '%</b></span></td>';
              }
            } else {
              tdEl = '<td>' + ave_stats[stat.value] + ' / ' + artifact_stats[stat.value];
              if (artifact_rates) {
                tdEl += '<br/><span>' + artifact_rates[stat.value] + '%</span></td>';
              }
            }

            typeStatsRow.append(tdEl);
          } else {
            typeStatsRow.append('<td> - </td>');
          }
        });
      });

      // get recipe
      $('#materials').addClass('hidden');
      $('#materials .cell').addClass('hidden');
      $('#materials table').empty();
      let mats = getTotalMaterials(item.iname, level);
      if (Object.entries(mats.recipe).length) {
        $('#recipe_mats table').append('<tr><th colspan="2">Recipe Materials</th></tr>');
        $('#recipe_mats table').append(getMaterialTableContents(mats.recipe));
        $('#recipe_mats').removeClass('hidden');
        $('#materials').removeClass('hidden');
      }

      if (Object.entries(mats.total).length) {
        $('#total_mats table').append('<tr><th colspan="2">Total Materials</th></tr>');
        $('#total_mats table').append(getMaterialTableContents(mats.total));
        $('#total_mats').removeClass('hidden');
        $('#materials').removeClass('hidden');
      }
      if (Object.entries(mats.awake).length) {
        $('#awake_mats table').append('<tr><th colspan="2">Awakening Materials</th></tr>');
        $('#awake_mats table').append(getMaterialTableContents(mats.awake));
        $('#awake_mats').removeClass('hidden');
        $('#materials').removeClass('hidden');
      }

      $('#content').removeClass('hidden');
    }

    function getBuffNames(_buff, grow, level) {
      let buffNamesEl = '';
      let buff = buffMap[_buff];
      let buff_text, killer_index_offset;
      let growth = growthMap[grow];

      // NOT SURE WHY THESE ARE OFF
      switch (_buff) {
        // Katana > Lightning Katana
        case 'BUFF_KAT_LW_OOOO_1_1':
          buff.tag1[0] = 100;
          break;
        // Accessory > Magical String
        case 'BUFF_ACC_LW_THLA_1_1':
          buff.type1 = 120;
          break;
      }

      let buff_index = 1;
      while (buff['type' + buff_index] && buff_index <= 9) {
        let buff_value_min = buff['val' + buff_index];
        let buff_value_max = buff['val' + buff_index + '1'];
        let buff_level = Math.min(level, growth.curve[0].lv);
        let buff_value = Math.floor((buff_level - 1) / (growth.curve[0].lv - 1) * (buff_value_max - buff_value_min) + buff_value_min);
        switch (buff['type' + buff_index]) {
          // Elemental Killer
          // Dagger -> Bloodsaoked Dagger
          case 119:
            killer_index_offset = 109;
            buff_text = buffNameList[buff['type' + buff_index] + buff['tag' + buff_index][0] + killer_index_offset].value + ' ' + buff_value;
            break;
          // Species Killer
          // Spear -> Drakeshorn Spear
          case 120:
            killer_index_offset = 27;
            buff_text = buffNameList[buff['type' + buff_index] + buff['tag' + buff_index][0] + killer_index_offset].value + ' ' + buff_value;
            break;
          // Condition Granted
          // Sword -> Vermillion
          case 123:
            let buff2 = buffMap[buff[['id' + buff_index]]];
            buff_text = buffNameList[buff2.type1].value + ' Granted (' + buff2.turn + ' turns, ' + buff2.rate + '%)';
            break;
          // Enchant
          // Sword -> Metal Slayer
          case 134:
            let enchant_index_offset = 27;
            buff_text = buffNameList[buff['type' + buff_index] + buff['tag' + buff_index][0] + enchant_index_offset].value + ' ' + buff_value;
            break;
          default:
          // 183 = Cast Time Reduced | Staff -> Magic Baton
          // 192 = Brave Bonus | Accessory -> Hero's Ring
          // 194 = Acquired JP | Sword -> Hollow Slave
            buff_text = buffNameList[buff['type' + buff_index]].value;

            switch (buff['calc' + buff_index]) {
              case 3:
                buff_text += ' Res';
                break;
            }

            buff_text += ' ' + buff_value;
            break;
        }
        buffNamesEl += '<div class="skill_desc">' + buff_text + '</div>';
        buff_index++;
      }

      return buffNamesEl;
    }

    function setItemInfo() {
      let itemKey = $('#artifacts').val();
      if (!itemKey) {
        return;
      }

      let item = artifactMap[itemKey];
      let types = typeMap[item.rtype];

      $('#level').empty();
      $('#grow_div').addClass('hidden');
      $('#grow_amt').addClass('hidden');
      $('#seals').addClass('hidden');
      $('#seals_tip').addClass('hidden');

      $('#grow_amt').empty();
      switch (types[0].value) {
        case 'ARTIFACT_TRUST':
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').val('1');
          $('#save_tip').removeClass('hidden');
          break;
        case 'ARTIFACT_50':
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').append('<option value="10">Lv. 10</option>');
          $('#level').append('<option value="20">Lv. 20</option>');
          $('#level').append('<option value="30">Lv. 30</option>');
          $('#level').val('30');
          $('#save_tip').removeClass('hidden');
          break;
        default:
          $('#level').append('<option value="1">Lv. 1</option>');
          $('#level').append('<option value="10">Lv. 10</option>');
          $('#level').append('<option value="20">Lv. 20</option>');
          $('#level').append('<option value="30">Lv. 30</option>');
          $('#level').append('<option value="40">Lv. 40</option>');
          $('#level').append('<option value="50">Lv. 50</option>');
          $('#level').val('50');

          $('#grow_amt').append('<th>Growth</th>');
          stats.forEach((stat, i) => {
            if (item.randa[0][stat.value]) {
              $('#grow_amt').append('<td>+' + item.randa[0][stat.value] + '</td>');
            } else {
              $('#grow_amt').append('<td>-</td>');
            }

            if ((item.status[0][stat.value] || item.status[1][stat.value])
                && item.status[0][stat.value] != item.status[1][stat.value]) {
              $('#seals .stat_' + i + ' img').removeClass('hidden');
              $('#equipment_pass .stat.stat_' + i + ' span').removeClass('hidden');
            }
          });

          $('#grow_amt').removeClass('hidden');
          $('#seals_tip').removeClass('hidden');
          $('#save_tip').addClass('hidden');
          $('#grow_div').removeClass('hidden');
          $('#seals').removeClass('hidden');
          $('#equipment_pass').removeClass('hidden');
          break;
      }
      $('#level').removeClass('hidden');
      $('#level').change();
      $('#itemLink').removeClass('hidden');

      $('#item_image').removeClass().addClass('equipment');
      switch (item.type) {
        case 0:
          $('#item_image').addClass('weapon');
          break;
        case 1:
          $('#item_image').addClass('armor');
          break;
        case 2:
          $('#item_image').addClass('accessory');
          break;
      }
    }

    let seals = {}
    function resetSealsAndPass() {
      seals = {};
      $('#seals').addClass('hidden');
      $('#seals .stat img').addClass('hidden');
      $('#seals .stat').removeClass('seal_on');
      $('#seals .stat input').prop('checked', false);

      $('#equipment_pass').addClass('hidden');
      $('#equipment_pass .stat span').addClass('hidden');
    }
    function toggleSeal(stat_index) {
      if ($('#seals .stat.stat_' + stat_index + ' img').hasClass('hidden')) {
        return;
      }

      $('#seals_tip').addClass('dismissed');
      $('#save_tip').removeClass('hidden');

      if (seals[stat_index] == 1) {
        $('#seals .stat.stat_' + stat_index).removeClass('seal_on');
        $('#seals .stat.stat_' + stat_index + ' input').prop('checked', false);
        delete seals[stat_index];
        displayStats();
      } else if (Object.keys(seals).length < 3) {
        seals[stat_index] = 1;
        $('#seals .stat.stat_' + stat_index).addClass('seal_on');
        $('#seals .stat.stat_' + stat_index + ' input').prop('checked', true);
        displayStats();
      }

      $('#seals_display').empty();
      let seal_txt = [];
      for (key in seals) {
        if (seals[key]) {
          seal_txt.push(stats[key].label);
        }
      }

      for (let i = seal_txt.length; i < 3; i++) {
        seal_txt.push('x');
      }

      $('#seals_display').text('(' + seal_txt.join(', ') + ')');
    }
    function getTotalMaterials(iname, lv) {
      let mats = {
        awake: {},
        recipe: {},
        total: {}
      };

      if (artifactRecipeMap[iname]) {
        artifactRecipeMap[iname].craft.forEach((material) => {
          switch (material.type) {
            case 0:
              if (mats.total[material.id]) {
                mats.total[material.id].num += parseInt(material.num);
              } else {
                mats.total[material.id] = JSON.parse(JSON.stringify(material));
              }
              break;
            case 1:
              let item_mats = getTotalMaterials(material.id, material.lv);

              for (let key in item_mats.total) {
                if (mats.total[key]) {
                  mats.total[key].num += parseInt(item_mats.total[key].num);
                } else {
                  mats.total[key] = JSON.parse(JSON.stringify(item_mats.total[key]));
                }
              }
              break;
          }

          if (mats.recipe[material.id]) {
            mats.recipe[material.id].num += material.num;
          } else {
            mats.recipe[material.id] = JSON.parse(JSON.stringify(material));
          }
        });
      }

      if (artifactAwakeMap[iname]) {
        artifactAwakeMap[iname].awakes.forEach((awake, i) => {
          if (awake.lv <= lv) {
            let mat_index = 1;
            while (awake['mat' + mat_index] && mat_index <= 9) {
              let mat = awake['mat' + mat_index].split(',');

              if (mats.awake[mat[0]]) {
                mats.awake[mat[0]].num += parseInt(mat[1]);
              } else {
                mats.awake[mat[0]] = {
                  num: parseInt(mat[1])
                };
              }
              if (mats.total[mat[0]]) {
                mats.total[mat[0]].num += parseInt(mat[1]);
              } else {
                mats.total[mat[0]] = {
                  num: parseInt(mat[1])
                };
              }
              mat_index++;
            }
          }
        });
      }

      return mats;
    }
    function getMaterialTableContents(materials) {
      let tableContent = $('<tbody></tbody>');

      for (let mat in materials) {
        let item = materials[mat].type ? artifactMap[mat] : itemMap[mat];
        let itemName = materials[mat].type ? (artifactNameMap[mat] ? artifactNameMap[mat] : mat) : itemNameMap[mat];
        let mat_url = mat_link + encodeURIComponent(itemName);
        let tr = $('<tr></tr>');
        let td = $('<td></td>');

        if (item.icon) {
          item = artifactMap[item.icon];
        }

        if (item.asset) {
          let img_url = 'https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/equipment/' + item.asset + '.png';
          if (materials[mat].type) {
            td.append('<div class="material"><img src="' + img_url + '"/></div>');
          } else {
            td.append('<div class="material recipe"><img src="' + img_url + '"/></div>');
          }
        } else {
          let img_url = 'https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master/img/items/' + mat + '.png';
          td.append('<div class="material"><img src="' + img_url + '"/></div>');
        }
        td.append('<div>' + materials[mat].num + 'x</div>');
        tr.append(td);
        tr.append('<td><a target="_blank" href="' + mat_url + '">' + itemName + '</a></td>');
        tableContent.append(tr);
      }

      return tableContent.html();
    }
    function save(el) {
      if ($('#saved .selectable').length >= 10) {
        return;
      }

      let newEl = $(el).clone();
      let itemKey = $('#artifacts').val();
      let item = artifactMap[itemKey];
      // let item_td = $('#skills').clone();
      item_td.attr('colspan', null);
      item_td.attr('id', null);
      item_td.prepend('<div><b>' + item.name + '</b></div>');

      newEl.attr('id', null);
      newEl.attr('onclick', "unsave(this)");
      newEl.prepend(item_td);
      $('#saved table').append(newEl);
      $('#saved .tips').removeClass('hidden');
      $('#saved').removeClass('hidden');
      $('#growth .tips').addClass('dismissed');

      setHash();
    }
    function unsave(el) {
      $(el).remove();

      if ($('#saved .selectable').length == 0) {
        $('#saved').addClass('hidden');
      }

      $('#saved .tips').addClass('dismissed');

      setHash();
    }

    function getArtifactStats(curve, base) {
      let artifact_stats = {};

      stats.forEach((stat) => {
        if (isNaN(base[stat.value])) {
          base[stat.value] = 0;
        }

        if (curve[stat.value]) {
          artifact_stats[stat.value] = (100 + curve[stat.value]) / 100 * base[stat.value];

          let isNeg = artifact_stats[stat.value] < 0;

          artifact_stats[stat.value] = Math.floor(Math.abs(artifact_stats[stat.value]));
          if (isNeg) {
            artifact_stats[stat.value] *= -1;
          }
        } else {
          artifact_stats[stat.value] = base[stat.value];
        }
      });

      return artifact_stats;
    }

    function getArtifactRates(adjust, base) {
      let artifact_rates = {};
      let passEnabled = $('#equipment_pass input').prop('checked');

      stats.forEach((stat, i) => {
        if (isNaN(base[stat.value])) {
          base[stat.value] = 0;
        }

        if (adjust[stat.value]) {
          artifact_rates[stat.value] = base[stat.value] + adjust[stat.value];
        } else {
          artifact_rates[stat.value] = base[stat.value];
        }

        if (seals[i] && sealGrowthMap[stat.value]) {
          artifact_rates[stat.value] += sealGrowthMap[stat.value];
        }

        if (passEnabled && sealGrowthMap[stat.value]) {
          artifact_rates[stat.value] += sealGrowthMap[stat.value];
        }

        if (artifact_rates[stat.value] < 0) {
          artifact_rates[stat.value] = 0;
        }
        if (artifact_rates[stat.value] > 100) {
          artifact_rates[stat.value] = 100;
        }
      });

      return artifact_rates;
    }

    let promiseList = [];
    let loadJP = false;
    let timestamp = (new Date()).getTime();
    location.search.substr(1).split('&').forEach((param) => {
      let params = param.split('=');
      if (params[0] == 'jp') {
        loadJP = true;
      }
    });

    let typeMap = {};
    const RAW_GIT_URL = 'https://raw.githubusercontent.com/shalzuth/wotv-ffbe-dump/master';
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON(RAW_GIT_URL + '/en/ArtifactGrow.json?t=' + timestamp, (data) => {
        let typeNameMap = {};
        data.infos.forEach((info) => {
          typeNameMap[info.key] = info.value;
        });
        // 20200422_4c9ea1e3
        $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/ArtifactRandLot.json?t=' + timestamp, (data) => {
          data.items.forEach((item) => {
            typeMap[item.iname] = [];
            if (item.lot[0].grow1) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow1],
                value: item.lot[0].grow1
              });
            }
            if (item.lot[0].grow2) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow2],
                value: item.lot[0].grow2
              });
            }
            if (item.lot[0].grow3) {
              typeMap[item.iname].push({
                label: typeNameMap[item.lot[0].grow3],
                value: item.lot[0].grow3
              });
            }
          });

          resolve();
        });
      });
    }));

    let growthMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/Grow.json?t=' + timestamp, (data) => {
        data.items.forEach((item) => {
          growthMap[item.type] = {
            curve: item.curve,
            rstatus : item.rstatus
          }
        });

        resolve();
      });
    }));

    let buffMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/Buff.json?t=' + timestamp, (data) => {
        data.items.forEach((item) => {
          buffMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let buffNameList = [];
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON(RAW_GIT_URL + '/en/Buff.json?t=' + timestamp, (data) => {
        // pretty sure this is the right list
        // but needs modifications for now
        buffNameList = data.infos;

        // modifications
        // remove first 7
        for (let i = 0; i < 7; i++) {
          buffNameList.splice(0,1);
        }
        // insert 16 dummy
        for (let i = 0; i < 16; i++) {
          buffNameList.splice(5,0,null);
        }
        // insert 12 dummy
        for (let i = 0; i < 11; i++) {
          buffNameList.splice(30,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(51,0,null);
        }
        // insert 4 dummy
        for (let i = 0; i < 4; i++) {
          buffNameList.splice(66,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(71,0,null);
        }
        // insert 1 dummy
        for (let i = 0; i < 1; i++) {
          buffNameList.splice(94,0,null);
        }
        // insert 1 dummy
        for (let i = 0; i < 1; i++) {
          buffNameList.splice(118,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(124,0,null);
        }
        // insert 4 dummy
        for (let i = 0; i < 4; i++) {
          buffNameList.splice(135,0,null);
        }
        // insert 8 dummy
        for (let i = 0; i < 8; i++) {
          buffNameList.splice(143,0,null);
        }
        // insert 10 dummy
        for (let i = 0; i < 10; i++) {
          buffNameList.splice(160,0,null);
        }
        // insert 7 dummy
        for (let i = 0; i < 7; i++) {
          buffNameList.splice(173,0,null);
        }
        // remove 31?
        for (let i = 0; i < 31; i++) {
          buffNameList.splice(183,1);
        }
        // insert 6 dummy
        for (let i = 0; i < 6; i++) {
          buffNameList.splice(184,0,null);
        }
        // insert 119 dummy
        for (let i = 0; i < 119; i++) {
          buffNameList.splice(200,0,null);
        }
        resolve();
      });
    }));

    let skillMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200429_0d4b0c72
      $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/Skill.json?t=' + timestamp, (data) => {
        data.items.forEach((item) => {
          skillMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let skillNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200429_0d4b0c72
      $.getJSON(RAW_GIT_URL + '/en/SkillName.json?t=' + timestamp, (data) => {
        data.infos.forEach((info) => {
          if (info.value) {
            skillNameMap[info.key] = info.value;
          }
        });

        resolve();
      });
    }));

    let artifactNameMap = {};
    let artifactMap = {};
    let artifactListByCat = [];
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON(RAW_GIT_URL + '/en/ArtifactName.json?t=' + timestamp, (data) => {
        data.infos.forEach((info) => {
          artifactNameMap[info.key] = info.value;
        });

        $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/Artifact.json?t=' + timestamp, (data) => {
          data.items.forEach((item) => {
            // blacklisted items
            if (item.iname.match(/AF_\w+_2/)
                && (artifactNameMap[item.iname] == null
                    || !artifactNameMap[item.iname].match(/.+\+2/))
                ) {
              return;
            }

            if (item.type >= 0) {
              if (artifactNameMap[item.iname] || loadJP) {
                artifactMap[item.iname] = item;
                artifactMap[item.iname].name = artifactNameMap[item.iname] ? artifactNameMap[item.iname] : item.iname;

                let artifactListEntry = {
                  label: artifactNameMap[item.iname],
                  value : item.iname
                };

                item.cat.forEach((cat) => {
                  if (artifactListByCat[cat] == null) {
                    artifactListByCat[cat] = [];
                  }

                  artifactListByCat[cat].push(artifactListEntry);
                });
              }
            }
          });

          artifactListByCat.forEach((artifactList, index, list) => {
            artifactList.sort((a, b) => {
              return a.label > b.label ? 1 : -1;
            });
          });

          resolve();
        });
      });
    }));

    let sealGrowthMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/ArtifactGrowItem.json?t=' + timestamp, (data) => {
        data.items.forEach((item) => {
          let stat = stats[item.grow_up[0].eff_dst];
          sealGrowthMap[stat.value] = item.grow_up[0].val;
        });

        resolve();
      });
    }));

    let artifactCategoryList = [];
    promiseList.push(new Promise((resolve, reject) => {
      // init
      $.getJSON(RAW_GIT_URL + '/en/ArtifactCategory.json?t=' + timestamp, (data) => {
        artifactCategoryList = data.infos;

        // Those categories are present in the category file but not counted in category id in artifact file, they must be deleted
        artifactCategoryList.splice(18,2); // LIGHTSHIELD, HEAVYSHIELD
        artifactCategoryList.splice(22,3); // LIGHTARMOR, HEAVYARMOR, ROBE
		artifactCategoryList.splice(23,1); // SEPARATOR

        resolve();
      });
    }));

    // RECIPES
    let artifactRecipeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/ArtifactRecipe.json?t=' + timestamp, (data) => {
        data.items.forEach((item) => {
          artifactRecipeMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let artifactAwakeMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3
      $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/ArtifactAwake.json?t=' + timestamp, (data) => {
        data.items.forEach((item) => {
          artifactAwakeMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let itemMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200506_199950f7
      $.getJSON(RAW_GIT_URL + (loadJP ? '/jp' : '') + '/data/Item.json?t=' + timestamp, (data) => {
        data.items.forEach((item) => {
          itemMap[item.iname] = item;
        });

        resolve();
      });
    }));

    let itemNameMap = {};
    promiseList.push(new Promise((resolve, reject) => {
      // 20200422_4c9ea1e3 translations
      $.getJSON(RAW_GIT_URL + '/en/ItemName.json?t=' + timestamp, (data) => {
        data.infos.forEach((info) => {
          itemNameMap[info.key] = info.value;
        });

        resolve();
      });
    }));

    function setHash() {
      let hash = {
        saved: []
      };

      let savedEl = $('#saved .selectable');
      if (savedEl.length > 0) {
        savedEl.each((index, el) => {
          hash.saved.push(el.innerHTML.replace(/(^<td>)|(<\/td>$)/g,'').split('</td><td>'));
        });

        window.location.hash = btoa(JSON.stringify(hash));
      } else {
        window.location.hash = '';
      }
    }

    function getHash(artifact, category, level) {
      return btoa(JSON.stringify({
        artifact: artifact,
        category: category,
        level: level
      }));
    }

    Promise.all(promiseList).then(() => {
      let categories = [];
      artifactCategoryList.forEach((cat, i) => {
        switch(cat.key) {
          case 'NONE':
          case 'HAMMER':
          case 'INSTRUMENT':
          case 'WHIP':
          case 'THROWING':
          case 'SEPARATOR':
            break;
          default:
            if (artifactListByCat[i]) {
			  // consider i > 22 as weapons, but this need to be reviewed when new equipment categories are released
              let type = i < 17 ? 'weapon' : (i < 22 ? 'armor' : (i == 22 ? 'accessory' : 'weapon'));
              categories.push({
                type: type,
                index: i,
                label: cat.value
              });
            }
            break;
        }
      });

      categories.sort((a, b) => {
        return a.label > b.label ? 1 : -1;
      });

      categories.forEach((category) => {
        $('#category-' + category.type).append('<option value="' + category.index + '">' + category.label + '</option>');
      });

      window.location.search.substring(1).split('&').forEach((searchParamString) => {
        let searchParam = searchParamString.split('=');

        if (searchParam[0] == 'i' && artifactMap[searchParam[1]]) {
          window.location.replace(
            window.location.href.substring(0, window.location.href.indexOf('?'))
            + '#'
            + btoa(JSON.stringify({
              category: artifactMap[searchParam[1]].cat[0],
              artifact: searchParam[1]
            }))
          );

          return;
        }
      });

      if (window.location.hash) {
        let unhash = JSON.parse(atob(window.location.hash.substr(1)));

        if (unhash.category) {
          $('#category').val(unhash.category);
          $('#category').change();

          if (unhash.artifact) {
            $('#artifacts').val(unhash.artifact);
            $('#artifacts').change();

            if (unhash.level) {
              $('#level').val(unhash.level);
              $('#level').change();
            }
          }
        }

        if (unhash.saved) {
          unhash.saved.forEach((data) => {
            $('#saved table').append('<tr class="selectable" onclick="unsave(this)"><td>' + data.join('</td><td>') + '</td></tr>');
          });

          if ($('#saved .selectable').length > 0) {
            $('#saved').removeClass('hidden');
          }
        }
      }

      $('#category').focus();
    });
  </script>
</body>
</html>
